{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE"
  },
  "services": {
    "wordpress": {
      "source": {
        "image": "wordpress:6-php8.2-apache"
      },
      "variables": {
        "WORDPRESS_DB_HOST": "${{MySQL.RAILWAY_PRIVATE_DOMAIN}}:3306",
        "WORDPRESS_DB_USER": "wordpress",
        "WORDPRESS_DB_PASSWORD": "${{MySQL.MYSQL_PASSWORD}}",
        "WORDPRESS_DB_NAME": "wordpress",
        "WORDPRESS_TABLE_PREFIX": "wp_",
        "WORDPRESS_CONFIG_EXTRA": "define('WP_REDIS_HOST', '${{Redis.RAILWAY_PRIVATE_DOMAIN}}'); define('WP_REDIS_PORT', 6379); define('WP_CACHE', true); define('WP_MEMORY_LIMIT', '512M'); ini_set('upload_max_filesize', '256M'); ini_set('post_max_size', '256M'); ini_set('max_execution_time', 300); ini_set('max_input_time', 300); ini_set('memory_limit', '512M');"
      },
      "domains": [
        {
          "name": "${{RAILWAY_STATIC_URL}}"
        }
      ],
      "healthcheckPath": "/wp-admin/install.php",
      "restartPolicyType": "ON_FAILURE",
      "restartPolicyMaxRetries": 10
    },
    "mysql": {
      "source": {
        "image": "mysql:8.0"
      },
      "variables": {
        "MYSQL_ROOT_PASSWORD": "${{shared.MYSQL_ROOT_PASSWORD}}",
        "MYSQL_DATABASE": "wordpress",
        "MYSQL_USER": "wordpress",
        "MYSQL_PASSWORD": "${{shared.MYSQL_PASSWORD}}",
        "MYSQL_CHARSET": "utf8mb4",
        "MYSQL_COLLATION": "utf8mb4_unicode_ci"
      },
      "volumes": [
        {
          "name": "mysql_data",
          "mountPath": "/var/lib/mysql"
        }
      ],
      "healthcheckPath": "/",
      "healthcheckTimeout": 30,
      "restartPolicyType": "ON_FAILURE",
      "restartPolicyMaxRetries": 10
    },
    "phpmyadmin": {
      "source": {
        "image": "phpmyadmin:5-apache"
      },
      "variables": {
        "PMA_HOST": "${{MySQL.RAILWAY_PRIVATE_DOMAIN}}",
        "PMA_PORT": "3306",
        "PMA_USER": "wordpress",
        "PMA_PASSWORD": "${{MySQL.MYSQL_PASSWORD}}",
        "MYSQL_ROOT_PASSWORD": "${{shared.MYSQL_ROOT_PASSWORD}}",
        "PMA_ARBITRARY": "1",
        "UPLOAD_LIMIT": "256M"
      },
      "domains": [
        {
          "name": "${{RAILWAY_STATIC_URL}}"
        }
      ],
      "healthcheckPath": "/",
      "restartPolicyType": "ON_FAILURE",
      "restartPolicyMaxRetries": 10
    },
    "redis": {
      "source": {
        "image": "redis:7-alpine"
      },
      "variables": {
        "REDIS_PASSWORD": "${{shared.REDIS_PASSWORD}}"
      },
      "startCommand": "redis-server --requirepass $REDIS_PASSWORD --maxmemory 256mb --maxmemory-policy allkeys-lru",
      "volumes": [
        {
          "name": "redis_data",
          "mountPath": "/data"
        }
      ],
      "healthcheckPath": "/",
      "restartPolicyType": "ON_FAILURE",
      "restartPolicyMaxRetries": 10
    }
  },
  "environments": {
    "production": {
      "variables": {
        "RAILWAY_ENVIRONMENT_NAME": "production"
      }
    }
  },
  "volumes": [
    {
      "name": "mysql_data"
    },
    {
      "name": "redis_data"
    },
    {
      "name": "wordpress_data"
    }
  ],
  "variables": {
    "MYSQL_ROOT_PASSWORD": {
      "description": "Root password for MySQL database",
      "default": "${{secret(32)}}"
    },
    "MYSQL_PASSWORD": {
      "description": "Password for WordPress MySQL user",
      "default": "${{secret(24)}}"
    },
    "REDIS_PASSWORD": {
      "description": "Password for Redis cache",
      "default": "${{secret(16)}}"
    }
  }
}
